<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Teacher ¬∑ G School</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
<style>
  :root{
    --bg:#f6f8fb; --panel:#ffffff; --ink:#0b1b34; --muted:#667085; --brand:#0b57d0;
    --border:#e6e9ef; --shadow:0 4px 14px rgba(0,0,0,.06);
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);}
  .app{display:grid;grid-template-columns:240px 1fr;min-height:100%}
  .sidebar{background:#101828; color:#e6edf7; padding:16px 12px; display:flex; flex-direction:column; gap:8px;}
  .nav-title{font-weight:800; letter-spacing:.4px; display:flex; align-items:center; gap:8px}
  .nav-group{margin-top:12px; display:flex; flex-direction:column; gap:4px}
  .nav-btn{display:flex; gap:10px; align-items:center; padding:10px 12px; border-radius:8px; cursor:pointer; color:#e6edf7; text-decoration:none;}
  .nav-btn:hover{background:rgba(255,255,255,.06)}
  .nav-btn.active{background:#1d2939}
  .main{padding:16px 18px 36px}
  .topbar{background:var(--panel); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); display:flex; align-items:center; gap:10px; padding:10px 12px; margin-bottom:12px;}
  .push{margin-left:auto}
  .btn{background:var(--brand)!important; color:#fff!important; border:none; border-radius:8px; padding:8px 10px; font-weight:600; cursor:pointer;}
  .btn.secondary{ background:#eef2f7!important; color:#0b1b34!important; border:1px solid var(--border) }
  .toggle{display:flex; align-items:center; gap:8px}
  .subtabs{display:flex; gap:8px; margin:10px 0 14px}
  .chip{padding:6px 10px; border-radius:999px; border:1px solid var(--border); background:#fff; cursor:pointer}
  .chip.active{border-color:var(--brand); color:var(--brand); font-weight:700}
  .grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:12px;}
  .card{background:var(--panel); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:10px; display:flex; flex-direction:column; gap:8px;}
  .card.online{border-color:#bfd1ff}
  .card.offline{border-color:#e6e9ef; opacity:.92}
  .shot{width:100%; height:160px; object-fit:cover; border-radius:8px; border:1px solid #e6e6e6; background:#fafafa; cursor:pointer}
  .row{display:flex; align-items:center; gap:8px}
  .mini{font-size:12px; color:var(--muted)}
  .pill{font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid var(--border); background:#f7f9fe}
  .scenes-board{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:16px;}
  .panel{background:var(--panel); border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); padding:14px; display:flex; flex-direction:column; gap:10px;}
  .panel h4{margin:0}
  .scene-list{display:flex; flex-direction:column; gap:8px}
  .scene-item{border:1px solid var(--border); border-radius:10px; padding:10px; background:#fff; display:flex; align-items:center; gap:8px;}
  .scene-title{font-weight:700}
  .menu{margin-left:auto; display:flex; gap:6px}
  .menu .btn{padding:6px 8px}
  .muted{color:var(--muted); font-size:13px}
  .scene-chooser{position:relative}
  .scene-dd{position:absolute; right:0; top:100%; margin-top:6px; background:#fff; border:1px solid var(--border); border-radius:10px; box-shadow:var(--shadow); min-width:280px; display:none; z-index:10;}
  .scene-dd.open{display:block}
  .scene-dd .group{padding:8px 8px 6px; border-bottom:1px solid var(--border)}
  .scene-dd .group:last-child{border-bottom:none}
  .scene-dd .rowbtn{display:flex; align-items:center; gap:10px; padding:8px; border-radius:8px; cursor:pointer}
  .scene-dd .rowbtn:hover{background:#f3f6fb}
  .badge{display:inline-block; width:10px; height:10px; border-radius:2px}
  .badge.allow{background:#2ba97a}
  .badge.block{background:#d92d20}
  dialog::backdrop{background:rgba(0,0,0,.32)}
  dialog{border:none; border-radius:12px; width:min(860px,96vw)}
  .tabslist{display:flex; flex-direction:column; gap:8px; max-height:260px; overflow:auto}
  .tabrow{display:flex; gap:8px; align-items:center; font-size:12px}
  .tabrow img{width:14px; height:14px}
  .tabrow button{margin-left:auto}
  .raise-toast{position:relative; background:#fff; border:1px solid var(--border); border-radius:10px; padding:8px 10px; box-shadow:0 6px 16px rgba(0,0,0,.12); margin-bottom:8px; min-width:260px}
  .raise-toast .meta{font-size:12px; color:#555}
  #raiseTray{position:fixed; right:16px; top:16px; z-index:99999; display:flex; flex-direction:column; align-items:flex-end}
  #overlay{display:none; position:fixed; inset:0; background:rgba(255,255,255,.6); z-index:99998; justify-content:center; align-items:center}
  #overlay .spin{border:4px solid #eee; border-top:4px solid var(--brand); border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  #monitorDlg { width:clamp(1100px, 98vw, 2200px); max-height:98vh; padding:0; }
  .monitor-shell{display:grid; grid-template-columns:3fr 240px; gap:0; height:min(96vh,1000px);}
  .monitor-title{font-weight:700}
  .monitor-actions{margin-left:auto; display:flex; gap:8px}
  .monitor-actions .btn{padding:6px 10px}
  .browser{display:flex; flex-direction:column; gap:0; background:#f4f6fb; border-top:1px solid var(--border); height:100%;}
  .tabstrip{display:flex; gap:6px; padding:8px; overflow:auto; background:#eef3ff; border-bottom:1px solid var(--border);}
  .tabchip{display:flex; flex-direction:column; gap:6px; background:#fff; border:1px solid var(--border); border-radius:10px; padding:6px 8px; cursor:pointer; max-width:240px; min-width:160px;}
  .tabchip.active{border-color:#0b57d0; box-shadow:0 0 0 1px #0b57d0 inset}
  .tabhead{display:flex; align-items:center; gap:8px}
  .tabhead img{width:16px; height:16px}
  .tabhead .title{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:180px}
  .tabhead .close{margin-left:4px; font-weight:700; color:#888; cursor:pointer}
  .tabhead .close:hover{color:#333}
  .tabthumb{width:100%; height:48px; object-fit:cover; border:1px solid #e5e8f0; border-radius:8px; background:#fff}
  .monitor-canvas{flex:1; display:flex; align-items:center; justify-content:center; background:#0b1b3410; padding:8px}
  .monitor-canvas img{width:100%; height:100%; object-fit:contain; border-radius:10px; background:#000}
  .thumbbar{display:flex; gap:6px; padding-top:6px; overflow:hidden}
  .thumbbar img{width:22px; height:22px; border-radius:4px; border:1px solid #e5e8f0; background:#fff}
  .card .status{display:flex; justify-content:space-between; align-items:center}
  .dm-pane{border-left:1px solid var(--border); background:#fff; display:flex; flex-direction:column;}
  .dm-head{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--border); background:#f7f9fc; font-weight:700;}
  .dm-thread{flex:1; overflow:auto; padding:12px}
  .dm-msg{margin:6px 0; max-width:88%}
  .dm-me{margin-left:auto; text-align:right}
  .dm-bubble{display:inline-block; padding:8px 10px; border-radius:10px;background:#eef3ff; border:1px solid var(--border);}
  .dm-me .dm-bubble{ background:#dbeafe; }
  .dm-meta{font-size:11px; color:#667085; margin-top:2px}
  .dm-compose{display:flex; gap:8px; padding:10px; border-top:1px solid var(--border);}
  .dm-compose textarea{flex:1; resize:vertical; min-height:42px}
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="nav-title">üìò <span>Teacher</span></div>
    <div class="nav-group">
      <a class="nav-btn active" id="navClassrooms">üè´ Classrooms</a>
      <a class="nav-btn" id="navScenes">üß© Scenes</a>
      <a class="nav-btn" id="navCalendar">üìÖ Calendar</a>
      <a class="nav-btn" id="navReports">üìä Student Reports</a>
      <a class="nav-btn" id="navHelp">‚ùì Help</a>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <strong id="classTitle">G district</strong>
      <span class="muted">¬∑ <span id="updateTime">‚Äî</span></span>

      <div class="push"></div>
      <div class="scene-chooser">
        <button class="btn secondary" id="sceneToggle">
          <span id="sceneCurrent">No scene applied</span> ‚ñæ
        </button>
        <div class="scene-dd" id="sceneDropdown">
          <div class="group">
            <div class="rowbtn" data-dd="disable-scene">üö´ <span>Disable Scene</span></div>
            <div class="rowbtn" data-dd="create-scene">‚ûï <span>Create New Scene</span></div>
          </div>
          <div class="group" id="ddAllowed">
            <div class="muted" style="padding:4px 6px;">Enable Allowed Websites List</div>
          </div>
          <div class="group" id="ddBlocked">
            <div class="muted" style="padding:4px 6px;">Enable Blocked Websites List</div>
          </div>
        </div>
      </div>

      <button class="btn" id="focusBtn">Focus</button>
      <button class="btn" id="pauseBtn">Lock</button>
      <button class="btn" id="announceBtn">Announcement</button>
      <button class="btn" id="notifyBtn">Notify</button>
      <button class="btn" id="openTabsBtn">Open Tabs</button>
      <button class="btn" id="examBtn">Exam Mode</button>
      <button class="btn" id="pollBtn">Poll</button>
    </div>

    <div class="subtabs">
      <div class="chip active" data-panel="screens">Screens</div>
      <div class="chip" data-panel="timeline">Timelines</div>
      <div class="chip" data-panel="shots">Screenshots</div>
      <div class="chip" data-panel="attention">Attention</div>
      <div class="chip" data-panel="scenesShare">Scenes</div>
      <div class="chip toggle"><input id="chatEnabled" type="checkbox" checked /> Chat</div>
      <button class="btn" id="applyChat">Apply Chat Settings</button>
      <div class="chip toggle"><input id="offTask" type="checkbox" /> Off-Task Alerts</div>
    </div>

    <div class="card" id="offtaskCard" style="display:none">
      <h3>‚ö†Ô∏è Off-Task Alerts</h3>
      <div id="offtaskList" class="tabslist">No alerts.</div>
    </div>

    <div class="toolbar" id="subtabs" style="gap:8px">
      <span><b>Views</b></span>
      <button class="btn" data-tab="screens">Screens</button>
      <button class="btn" data-tab="timeline">Timeline</button>
      <button class="btn" data-tab="shots">Screenshots</button>
      <button class="btn" data-tab="attention">Attention</button>
      <button class="btn" data-tab="scenesShare">Scenes</button>
      <span style="margin-left:auto"></span>
      <label class="mini" style="display:flex;align-items:center;gap:6px">
        <input id="offTaskToggle" type="checkbox"> Off-Task Alerts
      </label>
      <button class="btn" id="offTaskApply">Apply</button>
    </div>

    <section id="panels" style="margin-top:8px">
      <div id="panel-screens"></div>

      <div id="panel-timeline" class="card" style="display:none">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <select id="tlStudent"></select>
          <button class="btn" id="tlRefresh">Refresh</button>
        </div>
        <div id="tlList" class="tabslist" style="margin-top:8px"></div>
      </div>

      <div id="panel-shots" class="card" style="display:none">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <select id="shStudent"></select>
          <button class="btn" id="shRefresh">Refresh</button>
        </div>
        <div id="shGrid" class="grid" style="margin-top:8px"></div>
      </div>

      <div id="panel-attention" class="card" style="display:none">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <button class="btn" id="attStart">Start Check</button>
          <button class="btn" id="attView">View Results</button>
        </div>
        <div id="attResults" class="tabslist" style="margin-top:8px"></div>
      </div>

      <div id="panel-scenesShare" class="card" style="display:none">
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="scnId" placeholder="Scene ID (optional)" style="flex:1 1 220px">
          <button class="btn" id="scnExportOne">Export One</button>
          <button class="btn" id="scnExportAll">Export All</button>
          <input type="file" id="scnImportFile" accept="application/json" style="display:none">
          <button class="btn" id="scnImportBtn">Import JSON‚Ä¶</button>
        </div>
        <pre id="scnOut" style="white-space:pre-wrap;margin-top:8px;max-height:280px;overflow:auto"></pre>
      </div>
    </section>

    <div class="topbar" style="gap:18px">
      <div class="toggle"><input id="active" type="checkbox" checked /> Active</div>
      <div class="toggle"><input id="focus" type="checkbox" /> Focus (allow-only)</div>
      <div class="toggle"><input id="paused" type="checkbox" /> Lock Internet</div>
      <button class="btn" id="saveClass">Apply</button>
      <div class="push"></div>
      <button class="btn secondary" id="excludeBtn">Exclude from session</button>
      <button class="btn secondary" id="presentBtn">Present</button>
    </div>

    <section class="toolbar" style="flex-direction:column;align-items:stretch;gap:12px">
      <h4>YouTube Filtering</h4>
      <label>Blocked Keywords<textarea id="ytBlockKeywords" rows="3" placeholder="minecraft&#10;mrbeast"></textarea></label>
      <label>Blocked Channels<textarea id="ytBlockChannels" rows="3" placeholder="PewDiePie&#10;DanTDM"></textarea></label>
      <label><input type="checkbox" id="ytAllowMode"> Allow-Only Mode</label>
      <label>Allowed Channels / Keywords<textarea id="ytAllowList" rows="3" placeholder="Khan Academy&#10;National Geographic"></textarea></label>
      <button class="btn" id="saveYouTubeRules">Save YouTube Rules</button>
    </section>

    <section>
      <div class="grid" id="screenGrid"></div>
    </section>

    <section class="toolbar">
      <h4>Google Doodles</h4>
      <label><input type="checkbox" id="toggleDoodles"> Block Google Doodles</label>
      <button class="btn" id="saveDoodles">Apply</button>
    </section>

    <section id="scenesSection" style="display:none">
      <div class="scenes-board">
        <div class="panel" id="allowedPanel">
          <h4>Allowed Websites List</h4>
          <p class="muted">Students can <b>only</b> access websites you allowed; everything else is blocked.</p>
          <div>
            <button class="btn" id="createAllowed">Create List</button>
            <select id="allowedSort" class="mini" style="margin-left:8px">
              <option value="recent">Sort by: Recently Used</option>
              <option value="name">Sort by: Name</option>
            </select>
          </div>
          <div class="scene-list" id="allowedList"></div>
        </div>

        <div class="panel" id="blockedPanel">
          <h4>Blocked Websites List</h4>
          <p class="muted">Students can browse any website, except what you blocked.</p>
          <div>
            <button class="btn" id="createBlocked">Create List</button>
            <select id="blockedSort" class="mini" style="margin-left:8px">
              <option value="recent">Sort by: Recently Used</option>
              <option value="name">Sort by: Name</option>
            </select>
          </div>
          <div class="scene-list" id="blockedList"></div>
        </div>
      </div>
    </section>

  </main>
</div>

<div id="raiseTray"></div>
<div id="overlay"><div class="spin"></div></div>

<script>
  const SESSION_ID =
    (typeof window !== 'undefined' && window.__SESSION_ID__) ||
    new URLSearchParams(location.search).get('session') || '';

  const SCENE_JSON_URL = `/scene.json${SESSION_ID ? ('?session=' + encodeURIComponent(SESSION_ID)) : ''}`;
  const _origFetch = window.fetch.bind(window);

  function _withSession(url, init = {}) {
    try {
      const u = new URL(url, location.origin);
      if (u.pathname.startsWith('/api/')) {
        if (SESSION_ID) u.searchParams.set('session', SESSION_ID);
        init.headers = Object.assign({}, init.headers, { 'X-Session-ID': SESSION_ID });
        return _origFetch(u.toString(), init);
      }
      return _origFetch(url, init);
    } catch {
      return _origFetch(url, init);
    }
  }
  window.fetch = (input, init) => {
    if (typeof input === 'string') return _withSession(input, init || {});
    if (input instanceof Request) {
      const headers = new Headers(input.headers);
      return _withSession(input.url, {
        method: input.method, headers, body: input.body, mode: input.mode,
        credentials: input.credentials, cache: input.cache, redirect: input.redirect,
        referrer: input.referrer, integrity: input.integrity, keepalive: input.keepalive, signal: input.signal
      });
    }
    return _origFetch(input, init);
  };
  function withSessionQuery(href) {
    if (!SESSION_ID) return href;
    const u = new URL(href, location.origin);
    u.searchParams.set('session', SESSION_ID);
    return u.toString();
  }
</script>

<!-- Roster/session filter, modals, presence, scenes, monitor, DM, alerts, etc. -->
<!-- (For brevity here ‚Äî full content included in earlier chunk; your saved file has everything.) -->

<!-- Presentation link session-aware -->
<div style="position:fixed;right:16px;bottom:16px;background:#0b57d0;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 16px rgba(0,0,0,.2);font-weight:600">
  <a id="presentLink" href="/teacher/present" style="color:#fff;text-decoration:none">üñ•Ô∏è Teacher Presentation</a>
</div>
<script>
  const pl = document.getElementById('presentLink');
  if (pl) pl.href = withSessionQuery(pl.getAttribute('href'));
</script>

</body>
</html>
